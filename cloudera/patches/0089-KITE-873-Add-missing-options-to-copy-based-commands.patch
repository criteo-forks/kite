From 7ca8d83c4e51d5125f4a27e471ec921f0e1d13a7 Mon Sep 17 00:00:00 2001
From: Ryan Blue <blue@apache.org>
Date: Fri, 26 Jun 2015 17:32:29 -0700
Subject: [PATCH 089/140] KITE-873: Add missing options to copy-based
 commands.

---
 .../org/kitesdk/cli/commands/CSVImportCommand.java |   18 ++++++++++++++++++
 .../cli/commands/InputFormatImportCommand.java     |   18 ++++++++++++++++++
 .../kitesdk/cli/commands/JSONImportCommand.java    |   19 ++++++++++++++++++-
 .../org/kitesdk/cli/commands/TransformCommand.java |   10 ++++++++++
 4 files changed, 64 insertions(+), 1 deletion(-)

diff --git a/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/CSVImportCommand.java b/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/CSVImportCommand.java
index 00605be..4f381c5 100644
--- a/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/CSVImportCommand.java
+++ b/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/CSVImportCommand.java
@@ -28,6 +28,7 @@ import java.util.UUID;
 import org.apache.avro.Schema;
 import org.apache.crunch.DoFn;
 import org.apache.crunch.PipelineResult;
+import org.apache.crunch.Target;
 import org.apache.hadoop.fs.FileSystem;
 import org.apache.hadoop.fs.Path;
 import org.kitesdk.compat.DynConstructors;
@@ -86,6 +87,10 @@ public class CSVImportCommand extends BaseDatasetCommand {
       description="The number of writer processes to use")
   int numWriters = -1;
 
+  @Parameter(names={"--files-per-partition"},
+      description="The number of files per partition to create")
+  int filesPerPartition = -1;
+
   @Parameter(names={"--transform"},
       description="A transform DoFn class name")
   String transform = null;
@@ -94,6 +99,11 @@ public class CSVImportCommand extends BaseDatasetCommand {
       description="Add a jar to the runtime classpath")
   List<String> jars;
 
+  @Parameter(
+      names={"--overwrite"},
+      description="Remove any data already in the target view or dataset")
+  boolean overwrite = false;
+
   @Override
   @SuppressWarnings("unchecked")
   public int run() throws IOException {
@@ -183,6 +193,14 @@ public class CSVImportCommand extends BaseDatasetCommand {
         task.setNumWriters(numWriters);
       }
 
+      if (filesPerPartition > 0) {
+        task.setFilesPerPartition(filesPerPartition);
+      }
+
+      if (overwrite) {
+        task.setWriteMode(Target.WriteMode.OVERWRITE);
+      }
+
       PipelineResult result = task.run();
 
       if (result.succeeded()) {
diff --git a/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/InputFormatImportCommand.java b/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/InputFormatImportCommand.java
index 967f9b2..e345975 100644
--- a/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/InputFormatImportCommand.java
+++ b/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/InputFormatImportCommand.java
@@ -36,6 +36,7 @@ import java.util.concurrent.ThreadFactory;
 import org.apache.avro.Schema;
 import org.apache.crunch.DoFn;
 import org.apache.crunch.PipelineResult;
+import org.apache.crunch.Target;
 import org.apache.hadoop.fs.FileSystem;
 import org.apache.hadoop.fs.Path;
 import org.kitesdk.compat.DynConstructors;
@@ -82,6 +83,10 @@ public class InputFormatImportCommand extends BaseDatasetCommand {
       description="The number of writer processes to use")
   int numWriters = -1;
 
+  @Parameter(names={"--files-per-partition"},
+      description="The number of files per partition to create")
+  int filesPerPartition = -1;
+
   @Parameter(names={"--transform"},
       description="A transform DoFn class name")
   String transform = null;
@@ -90,6 +95,11 @@ public class InputFormatImportCommand extends BaseDatasetCommand {
       description="Add a jar to the runtime classpath")
   List<String> jars;
 
+  @Parameter(
+      names={"--overwrite"},
+      description="Remove any data already in the target view or dataset")
+  boolean overwrite = false;
+
   @Override
   @SuppressWarnings("unchecked")
   @edu.umd.cs.findbugs.annotations.SuppressWarnings(
@@ -174,6 +184,14 @@ public class InputFormatImportCommand extends BaseDatasetCommand {
         task.setNumWriters(numWriters);
       }
 
+      if (filesPerPartition > 0) {
+        task.setFilesPerPartition(filesPerPartition);
+      }
+
+      if (overwrite) {
+        task.setWriteMode(Target.WriteMode.OVERWRITE);
+      }
+
       PipelineResult result;
       try {
         result = runTaskWithClassLoader(task, loader);
diff --git a/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/JSONImportCommand.java b/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/JSONImportCommand.java
index 9dfb06a..c0c5eee 100644
--- a/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/JSONImportCommand.java
+++ b/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/JSONImportCommand.java
@@ -21,13 +21,13 @@ import com.beust.jcommander.Parameters;
 import com.google.common.base.Preconditions;
 import com.google.common.collect.Lists;
 import java.io.IOException;
-import java.nio.charset.Charset;
 import java.util.Iterator;
 import java.util.List;
 import java.util.UUID;
 import org.apache.avro.Schema;
 import org.apache.crunch.DoFn;
 import org.apache.crunch.PipelineResult;
+import org.apache.crunch.Target;
 import org.apache.hadoop.fs.FileSystem;
 import org.apache.hadoop.fs.Path;
 import org.kitesdk.compat.DynConstructors;
@@ -63,6 +63,10 @@ public class JSONImportCommand extends BaseDatasetCommand {
       description="The number of writer processes to use")
   int numWriters = -1;
 
+  @Parameter(names={"--files-per-partition"},
+      description="The number of files per partition to create")
+  int filesPerPartition = -1;
+
   @Parameter(names={"--transform"},
       description="A transform DoFn class name")
   String transform = null;
@@ -71,6 +75,11 @@ public class JSONImportCommand extends BaseDatasetCommand {
       description="Add a jar to the runtime classpath")
   List<String> jars;
 
+  @Parameter(
+      names={"--overwrite"},
+      description="Remove any data already in the target view or dataset")
+  boolean overwrite = false;
+
   @Override
   @SuppressWarnings("unchecked")
   public int run() throws IOException {
@@ -141,6 +150,14 @@ public class JSONImportCommand extends BaseDatasetCommand {
         task.setNumWriters(numWriters);
       }
 
+      if (filesPerPartition > 0) {
+        task.setFilesPerPartition(filesPerPartition);
+      }
+
+      if (overwrite) {
+        task.setWriteMode(Target.WriteMode.OVERWRITE);
+      }
+
       PipelineResult result = task.run();
 
       if (result.succeeded()) {
diff --git a/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/TransformCommand.java b/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/TransformCommand.java
index e774252..0409614 100644
--- a/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/TransformCommand.java
+++ b/kite-tools-parent/kite-tools/src/main/java/org/kitesdk/cli/commands/TransformCommand.java
@@ -24,6 +24,7 @@ import java.io.IOException;
 import java.util.List;
 import org.apache.crunch.DoFn;
 import org.apache.crunch.PipelineResult;
+import org.apache.crunch.Target;
 import org.kitesdk.compat.DynConstructors;
 import org.kitesdk.data.DatasetException;
 import org.kitesdk.data.View;
@@ -65,6 +66,11 @@ public class TransformCommand extends BaseDatasetCommand {
       description="Add a jar to the runtime classpath")
   List<String> jars;
 
+  @Parameter(
+      names={"--overwrite"},
+      description="Remove any data already in the target view or dataset")
+  boolean overwrite = false;
+
   @Override
   public int run() throws IOException {
     Preconditions.checkArgument(datasets != null && datasets.size() > 1,
@@ -110,6 +116,10 @@ public class TransformCommand extends BaseDatasetCommand {
       task.setFilesPerPartition(filesPerPartition);
     }
 
+    if (overwrite) {
+      task.setWriteMode(Target.WriteMode.OVERWRITE);
+    }
+
     PipelineResult result = task.run();
 
     if (result.succeeded()) {
-- 
1.7.9.5

